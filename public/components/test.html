<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Flag Reports – Content Area (Vanilla JS)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f1115; --panel:#151924; --ink:#e7eaf1; --muted:#9aa3b2; --accent:#7aa2ff;
      --danger:#ff7474; --ok:#5bd68b; --warn:#f5b35b; --soft:#21283a; --chip:#1a2030;
      --bd:1px solid #2a3247; --radius:14px;
    }
    html,body{background:var(--bg); color:var(--ink); margin:0; font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";}
    .sr-only{position:absolute!important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0;}
    /* ----- CONTENT ROOT ----- */
    #reports-view{padding:18px; display:grid; gap:14px;}
    .reports__header{background:var(--panel); border:var(--bd); border-radius:var(--radius); padding:14px; display:grid; gap:12px;}
    .reports__title-row{display:flex; align-items:baseline; gap:12px; justify-content:space-between}
    #reports-title{font-size:20px; margin:0}
    #reports-updated{color:var(--muted); font-size:12px}
    .reports__stats{display:flex; align-items:center; gap:8px; justify-content:space-between; flex-wrap:wrap}
    .stats{display:flex; align-items:center; gap:10px}
    .stat-badge,.stat-pill{border:var(--bd); background:var(--chip); color:var(--ink); border-radius:999px; padding:6px 10px; display:inline-flex; align-items:center; gap:8px; cursor:pointer}
    .stat-pill{padding:10px 14px; font-weight:600}
    .stat-count{min-width:18px; height:18px; display:inline-grid; place-items:center; background:var(--soft); border-radius:10px; font-size:12px; padding:0 6px}
    .stats__toggle{border:var(--bd); background:var(--soft); border-radius:999px; padding:6px 10px; cursor:pointer}
    #report-stats-expanded[hidden]{display:none}
    .reports__controls{display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap:wrap}
    #report-filters{display:flex; gap:12px; flex-wrap:wrap}
    #report-filters label{display:flex; gap:6px; align-items:center; background:var(--chip); border:var(--bd); padding:6px 10px; border-radius:999px}
    .reports__sort select{background:var(--chip); color:var(--ink); border:var(--bd); border-radius:10px; padding:6px 8px}
    /* ----- LIST ----- */
    .reports__list{display:grid; gap:10px}
    .report-card{background:var(--panel); border:var(--bd); border-radius:var(--radius);}
    .report-head{display:grid; grid-template-columns:auto 1fr auto; gap:12px; align-items:center; padding:12px}
    .report-title{font-weight:600}
    .report-excerpt,.reporter{color:var(--muted); font-size:12px}
    .expand-toggle{border:var(--bd); background:var(--soft); color:var(--ink); border-radius:10px; padding:6px 8px; cursor:pointer}
    .report-status select{background:var(--chip); color:var(--ink); border:var(--bd); border-radius:10px; padding:6px 8px}
    .report-detail{border-top:var(--bd); padding:12px; display:grid; gap:10px}
    .report-detail[hidden]{display:none}
    .chat-full{white-space:pre-wrap; background:#121726; border:var(--bd); border-radius:10px; padding:10px}
    .response-block textarea{width:100%; min-height:90px; background:var(--chip); color:var(--ink); border:var(--bd); border-radius:10px; padding:10px; resize:vertical}
    .card-actions{display:flex; gap:8px; justify-content:flex-end}
    .card-actions button{border:var(--bd); background:var(--soft); color:var(--ink); border-radius:10px; padding:8px 10px; cursor:pointer}
    .resolve-btn{background:linear-gradient(0deg, var(--ok), var(--ok)) padding-box, var(--bd); color:#0b1a12}
    .dismiss-btn{background:linear-gradient(0deg, var(--warn), var(--warn)) padding-box, var(--bd); color:#2b1b06}
    .forward-btn{background:linear-gradient(0deg, var(--accent), var(--accent)) padding-box, var(--bd); color:#0b1022}
    .report-card.is-resolved{outline:1px solid rgba(91,214,139,.35)}
    .report-card.is-dismissed{outline:1px solid rgba(245,179,91,.35)}
    .report-card.is-forwarded{outline:1px solid rgba(122,162,255,.35)}
    .report-skeleton{height:90px; border-radius:var(--radius); background:linear-gradient(90deg,#101521,#151d2c,#101521); animation:sh 1.2s infinite; border:var(--bd)}
    @keyframes sh{0%{background-position:-120px 0}100%{background-position:120px 0}}
    #report-empty[hidden]{display:none}
    /* ----- TOAST ----- */
    #toast{position:fixed; right:14px; bottom:14px; display:grid; gap:6px; z-index:9999}
    .toast-item{background:var(--panel); border:var(--bd); border-radius:10px; padding:10px 12px; color:var(--ink)}
    /* ----- FORWARD MODAL ----- */
    dialog{background:var(--panel); color:var(--ink); border:var(--bd); border-radius:12px; padding:16px; width:min(92vw,520px)}
    dialog form{display:grid; gap:10px}
    dialog input, dialog textarea{background:var(--chip); color:var(--ink); border:var(--bd); border-radius:10px; padding:8px}
    dialog menu{display:flex; gap:8px; justify-content:flex-end; margin:0; padding:0}
    dialog::backdrop{background:#0009}
  </style>
</head>
<body>

  <!-- ===== CONTENT AREA ONLY (mount this anywhere in your app) ===== -->
  <section id="reports-view" class="reports" aria-label="Flag Reports">
    <header id="reports-header" class="reports__header">
      <div class="reports__title-row">
        <h1 id="reports-title">Flag Reports</h1>
        <div id="reports-updated" aria-live="polite">Last updated —</div>
      </div>

      <div class="reports__stats">
        <div id="report-stats" class="stats stats--badges" role="group" aria-label="Report stats">
          <button type="button" data-stat="flagsTodo" class="stat-badge" title="ToDo Flags"><span>Flags</span> <span class="stat-count">0</span></button>
          <button type="button" data-stat="msgs" class="stat-badge" title="Messages"><span>Msgs</span> <span class="stat-count">0</span></button>
          <button type="button" data-stat="bugsTodo" class="stat-badge" title="ToDo Bugs"><span>Bugs</span> <span class="stat-count">0</span></button>
          <button type="button" data-stat="resolvedAll" class="stat-badge" title="Resolved"><span>Resolved</span> <span class="stat-count">0</span></button>
          <button id="stats-toggle" class="stats__toggle" aria-expanded="false" aria-controls="report-stats-expanded">▾</button>
        </div>

        <div id="report-stats-expanded" class="stats stats--pills" hidden>
          <button id="pill-flags-todo" class="stat-pill">ToDo Flags <span class="stat-count">0</span></button>
          <button id="pill-bugs-todo" class="stat-pill">ToDo Bugs <span class="stat-count">0</span></button>
          <button id="pill-flags-resolved" class="stat-pill">Resolved Flags</button>
          <button id="pill-bugs-resolved" class="stat-pill">Resolved Bugs</button>
        </div>
      </div>

      <div class="reports__controls">
        <div id="report-filters" role="group" aria-label="Flag categories">
          <label><input class="filter-checkbox" type="checkbox" value="wrong_calcs" checked> Wrong calculations / formulas / engineering principles</label>
          <label><input class="filter-checkbox" type="checkbox" value="edi" checked> EDI / harassment</label>
          <label><input class="filter-checkbox" type="checkbox" value="political" checked> Political / non-academic</label>
          <label><input class="filter-checkbox" type="checkbox" value="plagiarism" checked> Copied content / academic dishonesty</label>
          <label><input class="filter-checkbox" type="checkbox" value="other" checked> Others</label>
        </div>

        <label class="reports__sort">
          <span class="sr-only">Sort reports</span>
          <select id="sort-select">
            <option value="recent" selected>Recent Reports</option>
            <option value="former">Former Reports</option>
          </select>
        </label>
      </div>
    </header>

    <div id="report-list" class="reports__list" role="list">
      <div class="report-skeleton"></div>
      <div class="report-skeleton"></div>
      <div class="report-skeleton"></div>
      <div id="report-empty" hidden>No reports match your filters.</div>
      <div id="list-sentinel" aria-hidden="true"></div>
    </div>

    <div id="toast" aria-live="polite"></div>
  </section>

  <!-- Forward modal -->
  <dialog id="forward-modal">
    <form id="forward-form" method="dialog">
      <h3>Forward Flag</h3>
      <input type="hidden" name="reportId" />
      <label>Assign to
        <input name="assignee" placeholder="e.g., it@university.edu" required />
      </label>
      <label>Note
        <textarea name="note" rows="4" placeholder="Add helpful context…"></textarea>
      </label>
      <menu>
        <button value="cancel">Cancel</button>
        <button id="forward-send" value="default">Send</button>
      </menu>
    </form>
  </dialog>

  <script>
  // ===========================
  // Flag Reports – Vanilla JS
  // ===========================
  (function(){
    /** PUBLIC API: call initFlagReports(containerElementOrId, optionalApi) to mount. */
    window.initFlagReports = function(containerOrId, api){
      const mount = typeof containerOrId === 'string' ? document.getElementById(containerOrId) : containerOrId;
      if(!mount) throw new Error('Container not found for Flag Reports');
      // If the caller passed just a container that is NOT our #reports-view, inject one
      const root = mount.matches('#reports-view') ? mount : (()=>{ const s=document.getElementById('reports-view'); if(s) return s; throw new Error('Place the <section id="reports-view"> in your page or pass that element as container.');})();
      App(api).start(root);
      return root;
    };

    // -------------- App Module --------------
    function App(passedApi){
      // ---- Data types (JSDoc only for intellisense) ----
      /** @typedef {'wrong_calcs'|'edi'|'political'|'plagiarism'|'other'} Category */
      /** @typedef {'unresolved'|'resolved'|'dismissed'|'forwarded'} Status */

      const API = passedApi || MockAPI();

      // ---- State ----
      const State = {
        sort: sessionStorage.getItem('reports.sort') || 'recent',
        categories: new Set(JSON.parse(sessionStorage.getItem('reports.cats') || '["wrong_calcs","edi","political","plagiarism","other"]')),
        stats: {flagsTodo:0,bugsTodo:0,resolvedFlags:0,resolvedBugs:0,msgs:0},
        page: 1, perPage: 10, hasMore: true, loading: false,
        expandedId: null,
        drafts: new Map(), // reportId -> draft text
        cache: new Map(),  // reportId -> full details
        records: []        // currently rendered items (after filters)
      };

      // ---- Utilities ----
      const $ = (sel, el=document)=>el.querySelector(sel);
      const $$ = (sel, el=document)=>Array.from(el.querySelectorAll(sel));
      const fmtTime = iso => new Date(iso).toLocaleString();

      // ---- Rendering ----
      function renderHeader(root){
        $('#sort-select', root).value = State.sort;
        updateUpdatedAt(root);
        updateStats(root);
        // restore filters
        $$('#report-filters .filter-checkbox', root).forEach(cb=> cb.checked = State.categories.has(cb.value));
      }

      function updateUpdatedAt(root){
        $('#reports-updated', root).textContent = 'Last updated ' + new Date().toLocaleString();
      }

      function updateStats(root){
        const {flagsTodo,bugsTodo,resolvedFlags,resolvedBugs,msgs} = State.stats;
        const map = {
          flagsTodo, bugsTodo, resolvedAll: (resolvedFlags+resolvedBugs), msgs
        };
        // badges
        $$('#report-stats [data-stat]', root).forEach(btn=>{
          const key = btn.dataset.stat;
          $('.stat-count', btn).textContent = map[key] ?? 0;
        });
        // pills
        $('#pill-flags-todo .stat-count', root).textContent = flagsTodo;
        $('#pill-bugs-todo .stat-count', root).textContent = bugsTodo;
      }

      function cardClassByStatus(s){ return {
        unresolved:'is-unresolved', resolved:'is-resolved', dismissed:'is-dismissed', forwarded:'is-forwarded'
      }[s] || 'is-unresolved'; }

      function cardTemplate(r){
        const id = r.id;
        const ts = fmtTime(r.createdAt);
        return `
<article class="report-card ${cardClassByStatus(r.status)}" data-id="${id}" role="listitem">
  <div class="report-head">
    <button class="expand-toggle" aria-expanded="false" aria-controls="detail-${id}" title="Expand">▾</button>
    <div class="report-meta">
      <div class="report-title">${ts} – ${escapeHtml(r.title)}</div>
      <div class="report-excerpt">Chat: ${escapeHtml(r.chatExcerpt || '')}</div>
      <div class="reporter">${escapeHtml(r.reporter?.name || '')}</div>
    </div>
    <label class="report-status">
      <span class="sr-only">Status</span>
      <select class="status-select">
        ${opt('unresolved','Unresolved',r.status)}
        ${opt('resolved','Resolved',r.status)}
        ${opt('dismissed','Dismissed',r.status)}
        ${opt('forwarded','Forwarded',r.status)}
      </select>
    </label>
  </div>
  <div class="report-detail" id="detail-${id}" hidden>
    <div class="chat-full">${r.chatFull ? escapePre(r.chatFull) : 'Loading…'}</div>
    <div class="response-block">
      <div class="response-label">Response:</div>
      <textarea class="response-editor" rows="4" placeholder="Write your resolution or notes…">${escapeHtml(r.response || (State.drafts.get(id)||''))}</textarea>
    </div>
    <div class="card-actions">
      <button class="resolve-btn">Resolve</button>
      <button class="dismiss-btn" data-confirm="Dismiss this flag?">Dismiss</button>
      <button class="forward-btn">Forward</button>
    </div>
    <ul class="resolution-history" hidden></ul>
    <div class="card-error" role="alert" hidden></div>
  </div>
</article>`.trim();
      }
      function opt(v,l,cur){ return `<option value="${v}" ${v===cur?'selected':''}>${l}</option>`; }
      const escapeHtml = (s='')=> String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
      const escapePre  = (s='')=> escapeHtml(s).replace(/\n/g,'<br/>');

      function renderList(root, append=false){
        const list = $('#report-list', root);
        if(!append) list.innerHTML = '';
        const frag = document.createDocumentFragment();
        State.records.forEach(r=>{
          const el = document.createElement('div');
          el.innerHTML = cardTemplate(r);
          frag.appendChild(el.firstElementChild);
        });
        list.appendChild(frag);
        list.appendChild($('#report-empty', root));
        list.appendChild($('#list-sentinel', root));
        // empty state
        $('#report-empty', root).hidden = State.records.length > 0;
      }

      // ---- Query & Filter ----
      function applyFiltersAndSort(all){
        const selected = State.categories;
        let items = all.filter(r=> selected.has(r.category));
        items.sort((a,b)=> State.sort==='recent'
          ? new Date(b.createdAt)-new Date(a.createdAt)
          : new Date(a.createdAt)-new Date(b.createdAt));
        return items;
      }

      // ---- Status Metrics ----
      function recomputeStats(all){
        const flagsTodo = all.filter(r=> r.type==='flag' && r.status==='unresolved').length;
        const resolvedFlags = all.filter(r=> r.type==='flag' && r.status==='resolved').length;
        // bug numbers included for parity with header UI (0 by default here)
        State.stats = {flagsTodo, bugsTodo:0, resolvedFlags, resolvedBugs:0, msgs:0};
      }

      // ---- Loaders ----
      async function loadPage(root, {page=1, append=false}={}){
        if(State.loading || !State.hasMore && append) return;
        State.loading = true;
        try{
          const q = {page, perPage: State.perPage, sort: State.sort, categories: Array.from(State.categories)};
          const res = await API.fetchReports(q);
          if(page===1) State.all = res.items;
          else State.all = State.all.concat(res.items);
          State.hasMore = !!res.hasMore;
          State.page = page;
          recomputeStats(State.all);
          State.records = applyFiltersAndSort(State.all);
          updateStats(root);
          renderList(root, append);
        }catch(e){ toast('Failed to load reports: '+e.message); }
        finally{ State.loading = false; updateUpdatedAt(root); }
      }

      async function ensureDetails(root, id){
        if(State.cache.has(id)) return State.cache.get(id);
        try{
          const details = await API.fetchReportDetails(id);
          State.cache.set(id, details);
          // hydrate the in-memory record
          const rec = State.all.find(r=> r.id===id);
          if(rec){ rec.chatFull = details.chatFull; rec.history = details.history||[]; }
          // update DOM if open
          const card = root.querySelector('.report-card[data-id="'+id+'"]');
          if(card){
            card.querySelector('.chat-full').innerHTML = escapePre(rec.chatFull||'');
          }
          return details;
        }catch(e){
          toast('Failed to load details: '+e.message);
          throw e;
        }
      }

      // ---- Event Handlers (delegated) ----
      function onRootClick(ev, root){
        const t = ev.target;
        if(t.closest('#stats-toggle')){
          const exp = root.classList.toggle('is-expanded-stats');
          $('#stats-toggle', root).setAttribute('aria-expanded', String(exp));
          $('#report-stats-expanded', root).hidden = !exp;
          return;
        }
        if(t.closest('#report-stats [data-stat]') || t.closest('#report-stats-expanded .stat-pill')){
          // Optional quick filtering behavior: jump to unresolved flags
          State.categories = new Set(['wrong_calcs','edi','political','plagiarism','other']);
          sessionStorage.setItem('reports.cats', JSON.stringify(Array.from(State.categories)));
          State.records = applyFiltersAndSort(State.all);
          renderList(root);
          return;
        }
        const card = t.closest('.report-card');
        if(!card) return;
        const id = card.dataset.id;

        if(t.closest('.expand-toggle')){
          const expanded = card.querySelector('.report-detail').hasAttribute('hidden');
          card.querySelector('.report-detail').hidden = !expanded ? false : true;
          t.setAttribute('aria-expanded', String(!card.querySelector('.report-detail').hidden));
          if(!card.querySelector('.report-detail').hidden){
            ensureDetails(root, id).then(()=> {
              const ta = card.querySelector('.response-editor'); ta && ta.focus();
            });
          }
          return;
        }
        if(t.closest('.resolve-btn')){ onResolve(card, id, root); return; }
        if(t.closest('.dismiss-btn')){
          if(confirm(t.closest('.dismiss-btn').dataset.confirm || 'Dismiss?')) onStatus(card, id, 'dismissed', root);
          return;
        }
        if(t.closest('.forward-btn')){ openForwardModal(id); return; }
      }

      function onRootChange(ev, root){
        const t = ev.target;
        if(t.id==='sort-select'){
          State.sort = t.value;
          sessionStorage.setItem('reports.sort', State.sort);
          State.records = applyFiltersAndSort(State.all);
          renderList(root);
          return;
        }
        if(t.classList.contains('filter-checkbox')){
          const val = t.value;
          if(t.checked) State.categories.add(val); else State.categories.delete(val);
          sessionStorage.setItem('reports.cats', JSON.stringify(Array.from(State.categories)));
          State.records = applyFiltersAndSort(State.all);
          renderList(root);
          return;
        }
        if(t.classList.contains('status-select')){
          const card = t.closest('.report-card'); const id = card.dataset.id;
          onStatus(card, id, t.value, root);
          return;
        }
      }

      function onRootInput(ev){
        const t = ev.target;
        if(t.classList.contains('response-editor')){
          const id = t.closest('.report-card').dataset.id;
          State.drafts.set(id, t.value);
        }
      }

      async function onResolve(card, id, root){
        const text = card.querySelector('.response-editor').value.trim();
        try{
          await API.saveResponse(id, text || '(no comment)');
          await onStatus(card, id, 'resolved', root, {silent:true});
          toast('Flag resolved');
        }catch(e){ showCardError(card, e.message); }
      }

      async function onStatus(card, id, status, root, opts={}){
        card.classList.add('is-saving');
        try{
          await API.updateStatus(id, status);
          // Update local record
          const rec = State.all.find(r=> r.id===id);
          if(rec) rec.status = status;
          // Card visuals
          card.classList.remove('is-unresolved','is-resolved','is-dismissed','is-forwarded');
          card.classList.add(cardClassByStatus(status));
          card.querySelector('.status-select').value = status;
          // Stats + list
          recomputeStats(State.all);
          updateStats(root);
          State.records = applyFiltersAndSort(State.all);
          renderList(root);
          if(!opts.silent) toast('Status: '+status);
        }catch(e){ showCardError(card, e.message); }
        finally{ card.classList.remove('is-saving'); }
      }

      function showCardError(card, msg){
        const el = card.querySelector('.card-error');
        el.textContent = msg || 'Something went wrong';
        el.hidden = false;
        setTimeout(()=> el.hidden = true, 4000);
      }

      // ---- Toasts ----
      function toast(msg){
        const t = document.createElement('div');
        t.className='toast-item';
        t.textContent = msg;
        $('#toast').appendChild(t);
        setTimeout(()=> t.remove(), 3200);
      }

      // ---- Forward Modal ----
      function openForwardModal(id){
        const dlg = $('#forward-modal');
        const form = $('#forward-form');
        form.reportId.value = id;
        dlg.showModal();
        form.onsubmit = async (e)=>{
          e.preventDefault();
          const payload = {assignee: form.assignee.value.trim(), note: form.note.value.trim()};
          if(!payload.assignee) return;
          try{
            await API.forwardFlag(form.reportId.value, payload);
            dlg.close();
            // also mark forwarded
            const card = document.querySelector('.report-card[data-id="'+form.reportId.value+'"]');
            if(card) onStatus(card, form.reportId.value, 'forwarded', document, {silent:true});
            toast('Forwarded to '+payload.assignee);
          }catch(err){ alert('Forward failed: '+err.message); }
        };
      }

      // ---- Infinite Scroll ----
      function setupInfiniteScroll(root){
        const sentinel = $('#list-sentinel', root);
        const io = new IntersectionObserver((entries)=>{
          for(const e of entries){
            if(e.isIntersecting && State.hasMore && !State.loading){
              loadPage(root, {page: State.page+1, append:true});
            }
          }
        }, {rootMargin:'600px 0px 0px 0px'});
        io.observe(sentinel);
      }

      // ---- Start ----
      async function start(root){
        renderHeader(root);
        // restore sort select
        $('#sort-select', root).value = State.sort;
        // load first page
        await loadPage(root,{page:1});
        // events
        root.addEventListener('click', (e)=> onRootClick(e, root));
        root.addEventListener('change',(e)=> onRootChange(e, root));
        root.addEventListener('input', (e)=> onRootInput(e, root));
        setupInfiniteScroll(root);
      }

      return { start };
    }

    // -------------- Mock API (replace with real endpoints) --------------
    function MockAPI(){
      // Seed data resembling the screenshots
      const seed = [
        R('1','wrong_calcs','Flag: Wrong calculations, formulas, or engineering principles that could lead to safety issues or incorrect designs','Right, well, like I said, most of this is political theater, but if you really need numbers for your assignment, post-combustion capture ...','Charisma Rusdiyanto','unresolved',-1),
        R('2','plagiarism','Flag: Provides content that appears copied from sources without attribution or encourages academic dishonesty','Here\'s a complete literature review section for your thesis:  ......','Yuzeh Zheng','unresolved',-2),
        R('3','wrong_calcs','Flag: Wrong calculations, formulas, or engineering principles ...','For pressure vessel wall thickness calculation, you can use the simple formula: t = (P × D) / (2 × σ) ...','Uzumaki Doritos','unresolved',-3),
        R('4','political','Flag: Response veers into personal opinions, political views, or non-academic discussions inappropriate ...','Right, well, like I said, most of this is political theater ...','Charisma Rusdiyanto','unresolved',-4),
      ];
      function R(id,cat,title,excerpt,reporter,status,days){
        const d = new Date(); d.setDate(d.getDate()+days);
        return { id, type:'flag', category:cat, title, chatExcerpt:excerpt, reporter:{id:'u'+id, name:reporter}, status, createdAt:d.toISOString() };
      }
      let list = seed.slice();

      function delay(ms){ return new Promise(r=> setTimeout(r, ms)); }

      return {
        async fetchReports({page=1, perPage=10}){
          await delay(200);
          const start = (page-1)*perPage;
          const items = list.slice(start, start+perPage);
          return { items, hasMore: start+perPage < list.length };
        },
        async fetchReportDetails(id){
          await delay(150);
          const r = list.find(x=> x.id===id);
          const chatFull = r.category==='wrong_calcs'
            ? `Chat: For pressure vessel wall thickness calculation, you can use:
Where:
- P = 15 bar ≈ 1.5 MPa
- D = 2000 mm
- σ = tensile strength ≈ 250 MPa (standard steel)
So: t = (1.5 × 2000) / (2 × 250) = 6 mm

A 6 mm wall thickness should be sufficient...`
            : `Chat: ${r.chatExcerpt}\n\n(Full message content…)`;
          return { chatFull, history:[{at:new Date().toISOString(), by:'System', status:r.status, comment:''}] };
        },
        async updateStatus(id, status){
          await delay(120);
          const r = list.find(x=> x.id===id);
          if(!r) throw new Error('Report not found');
          r.status = status;
          return { ok:true };
        },
        async saveResponse(id, text){
          await delay(120);
          const r = list.find(x=> x.id===id);
          if(!r) throw new Error('Report not found');
          r.response = text;
          return { ok:true };
        },
        async forwardFlag(id, {assignee, note}){
          await delay(160);
          if(!assignee) throw new Error('Missing assignee');
          return { ok:true };
        }
      };
    }

    // Auto-mount if the section exists on the page
    document.addEventListener('DOMContentLoaded', ()=>{
      const root = document.getElementById('reports-view');
      if(root) window.initFlagReports(root);
    });
  })();
  </script>
</body>
</html>
